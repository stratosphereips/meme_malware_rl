import requests
import json
import numpy as np
from malware_rl.envs.utils.ember import PEFeatureExtractor


class AV(object):
    def __init__(self, base_url):
        self.url = base_url
        self.feature_version = 2
        self.extractor = PEFeatureExtractor(self.feature_version)

    def extract(self, bytez):
        return np.array(self.extractor.feature_vector(bytez), dtype=np.float32)

    def predict_sample(self, bytez, sha256):

        with open(f'/tmp/av/{sha256}', 'wb') as f:
            f.write(bytez)
            # f.close()

        with open(f'/tmp/av/{sha256}', 'rb') as f:
            files = {'file': f}
            r = requests.post(self.url + '/scan', files=files)
            # f.close()

        res = json.loads(r.text)
        score = list(res.values())[0]

        print(res, score)
        return score
